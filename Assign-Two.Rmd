---
title: "Assignment-Two"
output: html_document
date: "2022-10-20"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# U7117486 Assignment Two 

## Load in packages
```{r}
library(pacman)
p_load(bookdown, tidyverse, ggforce, flextable, latex2exp, png, magick, metafor) 
```

## Reading in the csv file 
```{r}
data <- read_csv("OA_activitydat_20190302_BIOL3207.csv")
data
```

## Omitting N/A data
```{r}
data <- na.omit(data)
data
```

## Drop irrelevant columns
```{r}
data <- subset(data, select = -c(comment, loc))
data
```

## Creating a summary of results 
```{r summaryTab}
summary1<- filter(data, treatment == "control") %>% group_by(species) %>% summarise(mean(activity), sd(activity), n())
colnames(summary1) <- c("Species", "ctrl.mean", "ctrl.sd", "ctrl.n")

summary2<- filter(data, treatment == "CO2") %>% group_by(species) %>% summarise(mean(activity), sd(activity), n())
colnames(summary2) <- c("Species", "oa.mean", "oa.sd", "oa.n")

summary <- merge(summary1, summary2)
summary
```
## Reading in the clark paper meta data
```{r}
clark_meta <- read_csv("clark_paper_data.csv")
clark_meta
```

## Binding the summary results to the study information meta data provided
```{r}
clark_data <- bind_cols(clark_meta, summary)
clark_data
```

## Reading in the larger meta data set 
```{r}
ocean_meta <- read_csv("ocean_meta_data.csv")
ocean_meta
```

## Binding the clark data to the larger meta data set 
```{r}
clark_data[, c(12)] <- sapply(clark_data[, c(12)], as.character)
clark_data[, c(7)] <- sapply(clark_data[, c(7)], as.character)
clark_data[, c(8)] <- sapply(clark_data[, c(8)], as.character)

merged_data <- bind_rows(ocean_meta, clark_data)
merged_data


# Getting rid of negative data
merged_data <- merged_data[which(merged_data$ctrl.n > 0),]
merged_data <- merged_data[which(merged_data$ctrl.mean > 0),]
merged_data <- merged_data[which(merged_data$ctrl.sd > 0),]
merged_data <- merged_data[which(merged_data$oa.n > 0),]
merged_data <- merged_data[which(merged_data$oa.mean > 0),]
merged_data <- merged_data[which(merged_data$oa.sd > 0),]

# Checking that negatives are excluded
max(merged_data$ctrl.mean,na.rm=FALSE)
min(merged_data$ctrl.mean,na.rm=FALSE)
max(merged_data$oa.mean,na.rm=FALSE)
min(merged_data$oa.mean,na.rm=FALSE)
max(merged_data$ctrl.n,na.rm=FALSE)
min(merged_data$ctrl.n,na.rm=FALSE)
max(merged_data$oa.n,na.rm=FALSE)
min(merged_data$oa.n,na.rm=FALSE)
```

## Correctly calculate the log response ratio (lnRR) effect size for every row of the dataframe using metafor’s escalc() function.
```{r}
# Log Response Ratio (lnRR)
merged_data <- metafor::escalc(measure = "ROM", m1i = ctrl.mean, sd1i = ctrl.sd, n1i = ctrl.n, m2i = oa.mean, sd2i = oa.sd, n2i = oa.n, data = merged_data, var.names = c("lnRR", "vlnRR"))

merged_data$residual <- 1:nrow(merged_data)
merged_data
```

# Correct meta-analytic model fitted to the data that controls for the sampling variance of lnRR. The model should include a random effect of study and observation. Use metafor’s rma.mv() function.
```{r}
metareg_v <- rma.mv(lnRR ~ 1, V = vlnRR, 
                    random = list(~1|Study, 
                                  ~1|residual), 
                    test = "t", dfs = "contain", 
                    data = merged_data)
summary(metareg_v)

r2 <- orchaRd::r2_ml(metareg_v)
r2
# vi = vector to specify the corresponding sampling variances.
# yi = 	vector to specify the observed effect sizes or outcomes.
```
```{r}

```

